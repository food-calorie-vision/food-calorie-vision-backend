# 부족 영양소 기반 레시피 추천 기능 구현 보고서

## 구현 완료 사항

### 1. 오늘 섭취 영양소 집계 및 분석 ✅

**구현 위치:** `app/api/v1/routes/recipes.py` (레시피 추천 API)

**기능:**
- 오늘 섭취한 음식들의 영양소 정보를 DB에서 조회
- 일일 권장량과 비교하여 부족한 영양소 분석
- 권장량의 50% 미만인 영양소를 부족 영양소로 판단

**분석 영양소:**
- 단백질, 식이섬유, 비타민A, 비타민C, 비타민E, 칼슘, 철분, 칼륨, 마그네슘

**코드 위치:**
```python
# 4. 오늘 섭취한 영양소 집계 및 부족 영양소 분석
today_nutrients_stmt = select(...)
# 부족한 영양소 분석 (권장량의 50% 미만인 경우)
```

### 2. 레시피 추천 프롬프트 개선 ✅

**구현 위치:** `app/services/recipe_recommendation_service.py`

**변경사항:**
- 오늘 식사 현황 정보 추가
- 부족한 영양소 정보를 프롬프트에 포함
- GPT가 부족한 영양소를 보완하는 재료를 포함한 레시피 추천하도록 지시

**프롬프트 예시:**
```
**오늘 식사 현황 및 부족 영양소:**
- 단백질: 권장량의 30%만 섭취 (부족)
- 식이섬유: 권장량의 20%만 섭취 (부족)

**중요:** 사용자가 요청한 재료에 추가로 부족한 영양소를 보완할 수 있는 재료를 포함한 레시피를 추천해주세요.
예: 단백질이 부족하면 닭가슴살, 계란, 두부 등을 추가하고, 식이섬유가 부족하면 채소, 과일, 견과류 등을 추가하세요.
```

### 3. 사용자 친화적 메시지 개선 ✅

**구현 위치:** `app/services/recipe_recommendation_service.py` - `_generate_user_friendly_message`

**변경사항:**
- 오늘 아무것도 안 먹었을 때: "오늘 아직 아무것도 드시지 않으셨네요!"
- 부족한 영양소가 있을 때: "오늘 섭취한 영양소를 확인해보니 {영양소}이(가) 부족하시네요!"
- 부족 영양소 보완 안내: "요청하신 재료에 추가로 부족한 영양소를 보완할 수 있는 재료가 들어간 레시피를 추천해드릴게요!"

### 4. API 파라미터 추가 ✅

**변경사항:**
- `get_recipe_recommendations` 함수에 다음 파라미터 추가:
  - `has_eaten_today: bool` - 오늘 식사 여부
  - `deficient_nutrients: List[Dict]` - 부족한 영양소 목록

## 작동 방식

### 시나리오 1: 오늘 아무것도 안 먹었을 때
1. 레시피 추천 API 호출 시 오늘 섭취한 음식이 없음 확인
2. `has_eaten_today=False` 전달
3. GPT 프롬프트에 "오늘 아직 아무것도 먹지 않았습니다" 포함
4. 사용자에게 "오늘 아직 아무것도 드시지 않으셨네요!" 메시지 표시

### 시나리오 2: 부족한 영양소가 있을 때
1. 오늘 섭취한 음식들의 영양소 집계
2. 일일 권장량과 비교하여 부족한 영양소 분석
3. 부족한 영양소 정보를 GPT 프롬프트에 포함
4. GPT가 사용자 요청 재료 + 부족 영양소 보완 재료 포함 레시피 추천
5. 사용자에게 부족 영양소 안내 메시지 표시

**예시:**
- 사용자 요청: "닭고기 요리 추천해줘"
- 부족 영양소: 단백질, 식이섬유
- GPT 추천: "닭가슴살 + 채소 + 견과류" 포함 레시피

## 복잡도 분석

### 구현 복잡도: 중간

**이유:**
1. ✅ **영양소 집계**: 기존 DB 쿼리 활용, 복잡도 낮음
2. ✅ **부족 영양소 분석**: 간단한 비교 로직, 복잡도 낮음
3. ✅ **프롬프트 수정**: 기존 프롬프트에 정보 추가, 복잡도 낮음
4. ✅ **GPT 활용**: GPT가 자동으로 재료 조합, 복잡도 낮음

**프롬프트 변경만으로 해결 가능:**
- 복잡한 알고리즘 불필요
- GPT가 부족 영양소를 보완하는 재료를 자동으로 추천
- 사용자 요청 재료와 부족 영양소 보완 재료를 자연스럽게 조합

## 건강 점수 계산식 변경사항

### 이전 계산식 (문제점)
```
단백질 점수 = protein_score * 0.5 (최대 50점)
식이섬유 점수 = fiber_score * 0.3 (최대 30점)
기본 점수 = 단백질 점수 + 식이섬유 점수
최종 점수 = 기본 점수 - (제한 영양소 * 0.2)
```

**문제점:**
- 점수가 너무 낮게 나옴 (47-48점)
- 건강 식단도 50-60점밖에 안 나옴

### 현재 계산식 (개선)
```
단백질 점수 = protein_score * 0.6 (최대 60점)
식이섬유 점수 = fiber_score * 0.4 (최대 40점)
기본 점수 = 단백질 점수 + 식이섬유 점수 (최대 100점)

추가 영양소 보너스 = 최대 30점
제한 영양소 감점 = negative_score * 0.15 (15%만 감점)

최소 점수 보장:
- 기본 점수 50점 이상 → 최소 70점 보장
- 기본 점수 30점 이상 → 최소 60점 보장
- 기본 점수 1점 이상 → 최소 50점 보장

건강 식단 보너스:
- 단백질 20% 이상 + 식이섬유 10% 이상 → 최대 20점 보너스
- 단백질 15% 이상 → 최대 15점 보너스
```

**개선 효과:**
- 건강 식단: 70-85점 이상 가능
- 일반 식단: 50-70점
- 점수 분포가 더 공정하고 의미 있음

## 테스트 시나리오

### 시나리오 1: 오늘 아무것도 안 먹었을 때
1. 사용자가 레시피 추천 요청
2. 백엔드에서 오늘 섭취한 음식이 없음 확인
3. GPT 프롬프트에 "오늘 아직 아무것도 먹지 않았습니다" 포함
4. 사용자에게 "오늘 아직 아무것도 드시지 않으셨네요!" 메시지 표시
5. GPT가 일반적인 건강 레시피 추천

### 시나리오 2: 단백질 부족
1. 사용자가 "닭고기 요리 추천해줘" 요청
2. 백엔드에서 오늘 단백질이 권장량의 30%만 섭취 확인
3. GPT 프롬프트에 "단백질: 권장량의 30%만 섭취 (부족)" 포함
4. 사용자에게 "단백질이 부족하시네요!" 메시지 표시
5. GPT가 "닭가슴살 + 계란 + 두부" 등 단백질이 풍부한 재료 포함 레시피 추천

### 시나리오 3: 여러 영양소 부족
1. 사용자가 "파스타 추천해줘" 요청
2. 백엔드에서 단백질, 식이섬유 부족 확인
3. GPT 프롬프트에 부족 영양소 정보 포함
4. 사용자에게 "단백질, 식이섬유가 부족하시네요!" 메시지 표시
5. GPT가 "파스타 + 닭가슴살 + 채소 + 견과류" 등 포함 레시피 추천

## 파일 변경사항

### 백엔드
1. `app/api/v1/routes/recipes.py`
   - 오늘 섭취 영양소 집계 로직 추가
   - 부족 영양소 분석 로직 추가
   - 레시피 추천 서비스 호출 시 부족 영양소 정보 전달

2. `app/services/recipe_recommendation_service.py`
   - `get_recipe_recommendations` 함수에 `has_eaten_today`, `deficient_nutrients` 파라미터 추가
   - GPT 프롬프트에 오늘 식사 현황 및 부족 영양소 정보 포함
   - `_generate_user_friendly_message` 함수에 부족 영양소 메시지 추가

3. `app/services/health_score_service.py`
   - 건강 점수 계산식 개선 (이전 보고서 참조)

### 문서
1. `HEALTH_SCORE_CALCULATION_CHANGES.md` - 건강 점수 계산식 변경사항 문서화

## 다음 단계 (선택사항)

1. **프론트엔드 개선**
   - 대시보드에서 부족 영양소 시각화
   - 레시피 추천 시 부족 영양소 강조 표시

2. **영양소 보완 재료 추천 개선**
   - 부족 영양소별 추천 재료 데이터베이스 구축
   - GPT가 더 정확한 재료 조합 추천

3. **사용자 피드백 수집**
   - 추천된 레시피의 만족도 조사
   - 부족 영양소 보완 효과 측정

## 결론

✅ **구현 완료**: 오늘 식사 현황 확인 및 부족 영양소 기반 레시피 추천 기능이 성공적으로 구현되었습니다.

✅ **복잡도**: 프롬프트 변경만으로 해결 가능하여 복잡도가 낮습니다.

✅ **효과**: 사용자가 요청한 재료에 부족한 영양소를 보완하는 재료가 자동으로 포함된 레시피를 받을 수 있습니다.

✅ **건강 점수**: 계산식이 개선되어 건강 식단은 70-85점 이상, 일반 식단은 50-70점을 받을 수 있습니다.

